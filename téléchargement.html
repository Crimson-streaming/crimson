<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#b81b0e">
    <meta name="author" content="Crimson">
    <title>téléchargement | Crimson - LE site de streaming</title>
    <meta name="description" content="Avec Crimson, profitez des derniers films et séries en VF HD, gratuitement et sans aucune publicité ! Ce qui ressemble à un rêve devient une réalité grâce à la révolution Crimson !" />

    <link rel="icon" type="image/png" href="img/favicon/favicon.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/megamenu.css">
    <link rel="stylesheet" href="css/style-three.css" id="theme">
    <link rel="stylesheet" href="css/ionicons.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/splide.min.css">
    <link rel="stylesheet" href="css/player-crimson.css">
    <link rel="stylesheet" href="css/jquery-eu-cookie-law-popup.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/validatesecurity.css">
    <link rel="stylesheet" href="css/search.css">

    <!-- SweetAlert2 -->
    <script src="js/sweetalert2@11.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800&display=swap" rel="stylesheet">

    <style>

        #film-container {
            background-color: #d9cece;
            max-width: 325px;
            margin: 30px auto;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 0 10px 3px #b81b0e;
        }

        #film-nom {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        #film-affiche {
            width: 100%;
            max-width: 200px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #cdbaba;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: none;
            /* box-shadow: 0 0 10px 3px #b81b0e; */


        }

        .progress-fill {
            height: 100%;
            background-color: #b81b0e;
            width: 0;
            border-radius: 5px 0 0 5px;
        }

        .download-info {
            font-size: 16px;
            color: #7d7185;
            margin-top: 10px;
        }

        #download-button {
            background-color: #b81b0e;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
        }

        #download-button:disabled {
            background-color:  #e0a59c;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <header>
        <div class="main-menu">
            <nav class="header-section pin-style">
                <div class="container-fluid">
                    <div class="mod-menu">
                        <div class="row">
                            <div class="col-2">
                                <a href="index.html" title="logo" class="logo"><img src="img/logo.png" alt="logo" title="logo"></a>
                            </div>
                            <div class="col-7 nav-order-last nopadding">
                                <div class="main-nav leftnav">
                                    <ul class="top-nav">
                                        <li class="visible-this d-md-none menu-icon">
                                            <a href="#" class="navbar-toggle collapsed" data-bs-toggle="collapse" data-bs-target="#menu" aria-expanded="false" title="menu-toggle"><i class="fa fa-bars"></i></a>
                                        </li>
                                    </ul>
                                    <div id="menu" class="collapse header-menu">
                                        <ul class="nav vfx-item-nav">
                                            <li><a href="index.html" title="home">Home</a></li>
                                            <li><a href="films.html" class="Active" title="Films">Films</a></li>
                                            <li><a href="direct.html" title="En direct">En direct</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="right-sub-item-area">
                                    <div class="search-item-block">
                                        <form class="navbar-form navbar-left">
                                            <a type="submit" href="#popup1" class="btn btn-default open" title="search"><i class="fa fa-search"></i></a>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div id="film-container">
        <h2 id="film-nom">Nom du Film</h2>
        <img id="film-affiche" src="" alt="Affiche du Film">
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
        </div>
        <p id="download-info" class="download-info">Préparation du téléchargement...</p>
        <button id="download-button" onclick="lancerTelechargement()">Télécharger</button>
    </div>

    <script>
        // Charger les informations du film depuis localStorage
        const films = JSON.parse(localStorage.getItem("filmsTelecharges")) || [];
        const film = films[films.length - 1]; // Récupérer le dernier film ajouté

        if (film) {
            document.getElementById("film-nom").textContent = film.nom;
            document.getElementById("film-affiche").src = film.affiche;
        }

        function lancerTelechargement() {
            const progressFill = document.getElementById("progress-fill");
            const downloadInfo = document.getElementById("download-info");
            const downloadButton = document.getElementById("download-button");

            // Désactiver le bouton pendant le téléchargement
            downloadButton.disabled = true;
            downloadInfo.textContent = "Téléchargement en cours...";

            // Téléchargement de la vidéo
            fetch(film.url)
                .then(response => {
                    if (!response.ok) throw new Error("Erreur lors du téléchargement");
                    const totalSize = parseInt(response.headers.get("content-length"), 10);
                    let loadedSize = 0;

                    const reader = response.body.getReader();
                    const stream = new ReadableStream({
                        start(controller) {
                            function push() {
                                reader.read().then(({ done, value }) => {
                                    if (done) {
                                        controller.close();
                                        return;
                                    }
                                    loadedSize += value.length;
                                    const pourcentage = (loadedSize / totalSize) * 100;
                                    progressFill.style.width = pourcentage + "%";
                                    downloadInfo.textContent = `Téléchargement : ${Math.round(pourcentage)}%`;

                                    controller.enqueue(value);
                                    push();
                                });
                            }
                            push();
                        }
                    });

                    return new Response(stream).blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `${film.nom}.mp4`;// Nom du fichier téléchargé
                    a.style.display = "none";
                    document.body.appendChild(a);
                    a.click();

                    // Libérer l'URL créée
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // Mettre à jour l'état dans localStorage
                    downloadInfo.textContent = "Téléchargement terminé !";
                    films[films.length - 1].etat = "Téléchargement terminé !";
                    localStorage.setItem("filmsTelecharges", JSON.stringify(films));
                    downloadButton.textContent = "Téléchargement terminé";
                })
                .catch(error => {
                    console.error("Erreur lors du téléchargement :", error);
                    downloadInfo.textContent = "Erreur lors du téléchargement.";
                    downloadButton.disabled = false;
                });
        }
    </script>
    <div id="popup1" class="popup-view popup-overlay">
        <div class="search">
          <div class="search-container has-results"><span class="title">Rechercher</span>
            <div class="search-input">
              <input type="text" name="s" id="search_box" class="search-container-input" placeholder="Titre" onkeyup="showSuggestions(this.value)" style="background: #0d071e;" autocomplete="off">
            </div>
          </div>
          <div class="search-results mt-4" id="search_output">
              
       
          </div>
        </div>
        <a class="close" href="#" title="close"><i class="fas fa-times"></i></a>
      </div>     
    <div class="eupopup eupopup-bottom"></div>
    <script>
    async function showSuggestions(query) {
        const searchOutput = document.getElementById('search_output');
        searchOutput.innerHTML = ''; // Réinitialiser les résultats
    
        if (!query) return; // Si la requête est vide, ne rien faire
    
        const response = await fetch('search/f.json');
        const movies = await response.json();
    
        const filteredMovies = movies.filter(movie => movie.nom.toLowerCase().includes(query.toLowerCase()));
    
        if (filteredMovies.length > 0) {
            filteredMovies.forEach(movie => {
                const movieDiv = document.createElement('div');
                movieDiv.classList.add('single-video');
                movieDiv.innerHTML = `
                    <a href="${movie.emplacement}">
                        <div class="video-img">
                            <span class="video-item-content">${movie.nom}</span>
                            <img src="${movie.affiche}" alt="${movie.nom}">
                        </div>
                    </a>
                `;
                searchOutput.appendChild(movieDiv);
            });
        } else {
            searchOutput.innerHTML = '<p>Aucun résultat trouvé.</p>';
        }
    }
    </script> 
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery.easing.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/megamenu.js"></script>
    <script src="js/splide.min.js"></script>
    <script src="js/custom-main.js"></script>
    <script src="js/jquery-eu-cookie-law-popup.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script>
        // Fonction exécutée lors de l'utilisation du clic droit.
        $(document).bind("contextmenu", function() {
            // On indique au navigateur de ne pas réagir en cas de clic droit.
            return false;
        });
        </script>

</body>

</html>
